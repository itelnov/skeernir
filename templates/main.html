<!-- templates/main.html -->
{% extends "base.html" %}
{% block title %}Main Page{% endblock %}
{% block content %}

<div id="main_chat" class="bg-gray-800 rounded-md" data-session-id="{{ session_id }}">
    <div class="flex flex-col">
        <div class="flex justify-end">
            <button hx-post="/logout"
                    hx-target="#main_chat"
                    hx-redirect="/"
                    hx-swap="outerHTML"
                    hx-push-url="true"
                    type="submit"
                    class="w-20 bg-red-500 text-white text-center justify-center 
                        px-2 py-2 rounded-lg hover:bg-red-600 transition-colors">
                Logout
            </button>
        </div>
    </div>
    <div class="flex flex-row h-[calc(100vh-80px)] overflow-hidden rounded-lg mb-2">
        <div id="left-panel" class="flex flex-col w-56 rounded-lg bg-gray-900 pb-4">
            <div class="flex flex-row justify-end">
                <div class="flex flex-row mb-2 mt-2 rounded text-left truncate 
                            whitespace-nowrap overflow-y-auto text-ellipsis">
                    <select name="selected_model" 
                            class="action bg-slate-800 text-white text-sm 
                                border, w-full border-slate-600 rounded-md 
                                py-2 px-2 transition duration-150 ease-in-out 
                                focus:outline-none focus:ring-2 focus:ring-blue-400 
                                focus:border-transparent hover:bg-slate-700"
                            id="graph_select"
                            hx-get="/loadmodel/{{session_id}}"
                            hx-target="body"
                            hx-trigger="change"
                            hx-on::before-request="
                                const ChatElement = document.getElementById('chat-messages');
                                ChatElement.classList.add('shine-animation');">
                            {{ model_list | safe }}
                    </select>
                </div>
                <button hx-get="/newconv/{{session_id}}"
                    hx-target="body"
                    hx-trigger="click"
                    hx-swap="innerHTML"
                    hx-push-url="true"
                    hx-on::before-request="
                        const ChatElement = document.getElementById('chat-messages');
                        ChatElement.classList.add('shine-animation');
                    "
                    class="new-conv-button px-4 py-2 rounded-lg">
                    <svg class="new-conv-icon" fill="none" width="25px" height="25px" viewBox="0 0 32 32">
                        <path d="M27.2,8.22H23.78V5.42A3.42,3.42,0,0,0,20.36,2H5.42A3.42,3.42,0,0,0,2,5.42V20.36a3.42,3.42,0,0,0,3.42,3.42h2.8V27.2A2.81,2.81,0,0,0,11,30H27.2A2.81,2.81,0,0,0,30,27.2V11A2.81,2.81,0,0,0,27.2,8.22ZM5.42,21.91a1.55,1.55,0,0,1-1.55-1.55V5.42A1.54,1.54,0,0,1,5.42,3.87H20.36a1.55,1.55,0,0,1,1.55,1.55v2.8H11A2.81,2.81,0,0,0,8.22,11V21.91ZM28.13,27.2a.93.93,0,0,1-.93.93H11a.93.93,0,0,1-.93-.93V11a.93.93,0,0,1,.93-.93H27.2a.93.93,0,0,1,.93.93Z" stroke="#FFFFFF" stroke-width="1" fill="#FFFFFF"/>
                        <path d="M24.09,18.18H20v-4a.93.93,0,1,0-1.86,0v4h-4a.93.93,0,0,0,0,1.86h4v4.05a.93.93,0,1,0,1.86,0V20h4.05a.93.93,0,1,0,0-1.86Z" stroke="#FFFFFF" stroke-width="1" fill="#FFFFFF"/>
                    </svg>
                </button>
            </div>
            <div class="overflow-y-auto h-full max-h-full text-xs">
                {{ conversation_list | safe }}
            </div>
        </div>

        <div class="flex justify-center w-full">

            <div id="chat-container" class="flex flex-col w-full max-w-3xl m-2">
                <div id="chat-messages" class="overflow-y-auto h-full max-h-full bg-gray-900 rounded-lg shadow-md p-2">
                    {{ previous_messages | safe }}
                </div>
                <div class="flex justify-center mt-4">
                    <div id="chat-input-container", class="w-full">
                        <form id="submit_form" class="static"
                            hx-post="/sendmessage/{{session_id}}"
                            hx-trigger="click from:#SubmitButton"
                            hx-encoding="multipart/form-data"
                            hx-on::before-request="
                                this.querySelector('textarea').value = '';
                                this.querySelector('textarea').style.height = 'auto';
                                const fileInput = this.querySelector('input[type=file]');
                                fileInput.value = '';
                                const fileListContainer = document.getElementById('file-list');
                                fileListContainer.innerHTML = '';
                                const noFilesDiv = document.createElement('div');
                                noFilesDiv.className = 'text-sm text-gray-500';
                                noFilesDiv.textContent = 'No files attached';
                                fileListContainer.appendChild(noFilesDiv);"
                            hx-on::after-request="
                                console.log('after-request');
                                StartStream()
                                    .then(() => {
                                        console.log('Stream is ready');
                                    })
                                    .catch((error) => console.log(
                                        'Stream start failed', error));
                                "
                            hx-swap="none">
                            <div class="relative">
                                <div class="pb-10 bg-gray-700 overflow-hidden 
                                    rounded-t-xl rounded-b-3xl border-gray-400">
                                    <textarea
                                        id="user_input"
                                        name="message"
                                        value=""
                                        placeholder="Type your message..."
                                        rows="1"
                                        class="rounded-lg min-h-12 max-h-40 p-3 w-full focus:outline-none resize-y"
                                        oninput="
                                            this.style.height = 'auto';
                                            this.style.height = this.scrollHeight + 'px'
                                            "
                                        required
                                        autofocus></textarea>
                                </div>
                                <div class="absolute bottom-0 right-0">
                                    <button
                                        id="SubmitButton"
                                        type="submit"
                                        class="bg-gray-400 px-2 py-2 
                                            rounded-full hover:bg-gray-500
                                            transition-colors flex-shrink-0">
                                        <svg width="25px" height="25px" viewBox="-0.5 0 25 25" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M9.16109 12.9424L2.91109 12.4324C2.42109 12.3124 2.35109 11.6724 2.80109 11.4624L20.7111 3.55243C21.1811 3.34243 21.6711 3.81243 21.4411 4.25243L13.0111 21.2124C12.7811 21.6424 12.1211 21.5724 12.0011 21.1124L11.1711 13.2124L18.4411 6.41243" stroke="#000000" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                    </button>
                                </div>
                                <div class="absolute bottom-0 left-0 px-2
                                            py-2 bg-gray-400 rounded-full
                                            hover:bg-gray-500 transition-colors 
                                            flex-shrink-0">
                                    <label for="files-attached">
                                        <svg width="25px" height="25px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M11.7716 3.74346C14.113 1.39988 17.912 1.39988 20.2552 3.74302C22.4625 5.95037 22.5904 9.4497 20.639 11.8068C20.1751 11.5505 19.6767 11.3493 19.1524 11.2119L19.1964 11.1679C20.9519 9.41028 20.9519 6.56104 19.1945 4.80368C17.4921 3.10124 14.7649 3.04804 12.9984 4.64408L12.8305 4.80368L12.818 4.81799L3.28167 14.3543C2.98878 14.6472 2.51391 14.6472 2.22101 14.3543C1.95475 14.0881 1.93054 13.6714 2.14839 13.3778L2.22101 13.2937L11.7699 3.74302L11.7716 3.74346Z" fill="#212121"/>
                                            <path d="M11.2115 19.1508C11.3513 19.6848 11.5573 20.1921 11.8203 20.6632L11.4426 21.0408L11.406 21.071C9.9448 22.3878 7.6908 22.3431 6.28343 20.9357C4.96441 19.6167 4.84229 17.554 5.91708 16.0973C5.94042 16.0519 5.96867 16.0082 6.00188 15.967L6.05544 15.9074L6.14234 15.8197L6.28343 15.6718L6.28634 15.6747L13.7221 8.22035C13.988 7.95373 14.4046 7.92897 14.6985 8.14643L14.7827 8.21894C15.0494 8.48485 15.0741 8.90148 14.8567 9.19538L14.7842 9.2796L7.18953 16.8927C6.4719 17.7683 6.52178 19.0626 7.33917 19.88C8.16824 20.709 9.48789 20.7485 10.3637 19.9984L11.2115 19.1508Z" fill="#212121"/>
                                            <path d="M23 17.5C23 20.5376 20.5376 23 17.5 23C14.4624 23 12 20.5376 12 17.5C12 14.4624 14.4624 12 17.5 12C20.5376 12 23 14.4624 23 17.5ZM14.5 17C14.2239 17 14 17.2239 14 17.5C14 17.7761 14.2239 18 14.5 18H19.2929L17.6464 19.6464C17.4512 19.8417 17.4512 20.1583 17.6464 20.3536C17.8417 20.5488 18.1583 20.5488 18.3536 20.3536L20.8536 17.8536C21.0488 17.6583 21.0488 17.3417 20.8536 17.1464L18.3536 14.6464C18.1583 14.4512 17.8417 14.4512 17.6464 14.6464C17.4512 14.8417 17.4512 15.1583 17.6464 15.3536L19.2929 17L14.5 17Z" fill="#212121"/>
                                        </svg>
                                    </label>
                                    <input
                                        type="file"
                                        id="files-attached"
                                        name="file"
                                        max="20971520"
                                        multiple
                                        class="hidden"
                                        onchange="updateFileList(this)">
                                </div>
                            </div>
                        </form>
                        <div id="file-list"
                            class="bottom-0 bg-gray-900 mt-2 p-2 w-72
                                max-h-20 rounded-lg overflow-y-auto">
                            <div class="text-sm text-gray-500">No files attached</div>
                        </div>
                    </div>
                </div>
            </div>
            {{ right_container | safe }}
        </div>
    </div>
</div>
{% endblock %}
<!-- accept=".jpg, .jpeg, .png, .gif" -->